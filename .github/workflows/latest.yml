name: Latest Release

on:
  push:
    branches:
      - master
    paths:
      - 'package.json'
  workflow_dispatch:

jobs:
  update-latest:
    name: Update Latest Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: latest_tag
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest tag: $LATEST_TAG"

      - name: Get package version
        id: package_version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "Package version: $PACKAGE_VERSION"

      - name: Create or update latest release
        if: steps.latest_tag.outputs.latest_tag != format('v{0}', steps.package_version.outputs.package_version)
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ steps.package_version.outputs.package_version }}
          name: Skid-Inc v${{ steps.package_version.outputs.package_version }}
          body: "Automatically created release for version ${{ steps.package_version.outputs.package_version }}"
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          makeLatest: true
          draft: false
          prerelease: false