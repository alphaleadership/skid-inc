name: Latest Release

on:
  push:
    branches:
      - master
    paths:
      - 'package.json'
  workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build:automated

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  update-latest:
    name: Update Latest Release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get package version
        id: package_version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "Package version: $PACKAGE_VERSION"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Calculate file hashes and sizes
        id: file_info
        run: |
          cd artifacts
          # Windows
          if [ -f "win-x64/Skid-Inc-Setup-*.exe" ]; then
            WIN_FILE=$(ls win-x64/Skid-Inc-Setup-*.exe | head -n 1)
            WIN_SHA256=$(sha256sum $WIN_FILE | awk '{ print $1 }')
            WIN_SIZE=$(stat -c "%s" $WIN_FILE)
            echo "win_file=$WIN_FILE" >> $GITHUB_OUTPUT
            echo "win_sha256=$WIN_SHA256" >> $GITHUB_OUTPUT
            echo "win_size=$WIN_SIZE" >> $GITHUB_OUTPUT
          fi
          # macOS
          if [ -f "mac-x64/Skid-Inc-*.dmg" ]; then
            MAC_FILE=$(ls mac-x64/Skid-Inc-*.dmg | head -n 1)
            MAC_SHA256=$(sha256sum $MAC_FILE | awk '{ print $1 }')
            MAC_SIZE=$(stat -c "%s" $MAC_FILE)
            echo "mac_file=$MAC_FILE" >> $GITHUB_OUTPUT
            echo "mac_sha256=$MAC_SHA256" >> $GITHUB_OUTPUT
            echo "mac_size=$MAC_SIZE" >> $GITHUB_OUTPUT
          fi
          # Linux
          if [ -f "linux-x64/Skid-Inc-*.AppImage" ]; then
            LINUX_FILE=$(ls linux-x64/Skid-Inc-*.AppImage | head -n 1)
            LINUX_SHA256=$(sha256sum $LINUX_FILE | awk '{ print $1 }')
            LINUX_SIZE=$(stat -c "%s" $LINUX_FILE)
            echo "linux_file=$LINUX_FILE" >> $GITHUB_OUTPUT
            echo "linux_sha256=$LINUX_SHA256" >> $GITHUB_OUTPUT
            echo "linux_size=$LINUX_SIZE" >> $GITHUB_OUTPUT
          fi

      - name: Generate latest.yml for electron-updater
        run: |
          cat > latest.yml <<EOF
          version: v${{ steps.package_version.outputs.package_version }}
          files:
            - url: https://github.com/alphaleadership/skid-inc/releases/download/v${{ steps.package_version.outputs.package_version }}/$(basename ${{ steps.file_info.outputs.win_file }})
              sha256: ${{ steps.file_info.outputs.win_sha256 }}
              size: ${{ steps.file_info.outputs.win_size }}
            - url: https://github.com/alphaleadership/skid-inc/releases/download/v${{ steps.package_version.outputs.package_version }}/$(basename ${{ steps.file_info.outputs.mac_file }})
              sha256: ${{ steps.file_info.outputs.mac_sha256 }}
              size: ${{ steps.file_info.outputs.mac_size }}
            - url: https://github.com/alphaleadership/skid-inc/releases/download/v${{ steps.package_version.outputs.package_version }}/$(basename ${{ steps.file_info.outputs.linux_file }})
              sha256: ${{ steps.file_info.outputs.linux_sha256 }}
              size: ${{ steps.file_info.outputs.linux_size }}
          path: Skid-Inc-Setup-${{ steps.package_version.outputs.package_version }}.exe
          sha256: ${{ steps.file_info.outputs.win_sha256 }}
          releaseName: Skid-Inc v${{ steps.package_version.outputs.package_version }}
          releaseNotes: "Automatically generated release for version ${{ steps.package_version.outputs.package_version }}"
          releaseDate: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          EOF

          echo "Generated latest.yml:"
          cat latest.yml

      - name: Upload latest.yml as artifact
        uses: actions/upload-artifact@v4
        with:
          name: latest.yml
          path: latest.yml
          retention-days: 7

      - name: Create or update latest release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ steps.package_version.outputs.package_version }}
          name: Skid-Inc v${{ steps.package_version.outputs.package_version }}
          body: "Automatically created release for version ${{ steps.package_version.outputs.package_version }}"
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          makeLatest: true
          draft: false
          prerelease: false
          artifacts: "latest.yml"